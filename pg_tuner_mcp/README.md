# pg_tuner_mcp

MCP (Model Context Protocol) server for PostgreSQL tuning analysis, integrating with `pg_workload` benchmark reports.

## Overview

`pg_tuner_mcp` provides AI-assisted analysis of PostgreSQL performance through Claude Desktop integration. It analyzes benchmark reports generated by `pg_workload` and provides tuning recommendations.

### Available Tools

| Tool | Description | Status |
|------|-------------|--------|
| `ping` | Check server health and version | Implemented |
| `analyze_burst_report` | Analyze burst mode benchmark reports | Placeholder |
| `analyze_simulation_report` | Analyze simulation mode reports with timeline | Placeholder |
| `compare_reports` | Compare two reports for regression detection | Placeholder |

## Installation

### Prerequisites

- Python 3.10 or higher
- pip or uv package manager

### Install from source

```bash
cd ~/develop/pg_tuner/pg_tuner_mcp

# Using pip
pip install -e .

# Or using uv
uv pip install -e .

# Install dev dependencies for testing
pip install -e ".[dev]"
```

## Usage

### Command Line

```bash
# Show help
pg_tuner_mcp --help

# Show version
pg_tuner_mcp --version

# Run server (normally started by Claude Desktop)
pg_tuner_mcp

# Run with debug logging
LOG_LEVEL=DEBUG pg_tuner_mcp
```

### As Python Module

```bash
python -m pg_tuner_mcp --help
```

## Claude Desktop Configuration

Add the following to your Claude Desktop configuration file:

**macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`
**Windows**: `%APPDATA%\Claude\claude_desktop_config.json`
**Linux**: `~/.config/Claude/claude_desktop_config.json`

```json
{
  "mcpServers": {
    "pg_tuner": {
      "command": "python",
      "args": ["-m", "pg_tuner_mcp"],
      "cwd": "/home/user/develop/pg_tuner/pg_tuner_mcp",
      "env": {
        "LOG_LEVEL": "INFO"
      }
    }
  }
}
```

Or if installed globally:

```json
{
  "mcpServers": {
    "pg_tuner": {
      "command": "pg_tuner_mcp",
      "env": {
        "LOG_LEVEL": "INFO"
      }
    }
  }
}
```

After updating the configuration, restart Claude Desktop.

## Testing

### Run Tests

```bash
# Run all tests
pytest

# Run with verbose output
pytest -v

# Run specific test file
pytest tests/test_placeholder.py

# Run with coverage
pytest --cov=pg_tuner_mcp
```

### Manual Testing

1. Start the server in a terminal:
   ```bash
   pg_tuner_mcp
   ```

2. The server will wait for MCP protocol messages on stdin.

3. To test with Claude Desktop:
   - Configure Claude Desktop as shown above
   - Restart Claude Desktop
   - Ask Claude: "Use the pg_tuner ping tool"
   - Claude should respond with: `{"status": "ok", "version": "0.1.0"}`

### Test MCP Communication

You can test the MCP protocol manually using the MCP inspector:

```bash
# Install mcp-inspector (if available)
pip install mcp-inspector

# Test the server
mcp-inspector pg_tuner_mcp
```

## Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `LOG_LEVEL` | Logging level (DEBUG, INFO, WARNING, ERROR) | INFO |

## Development

### Project Structure

```
pg_tuner_mcp/
├── src/
│   └── pg_tuner_mcp/
│       ├── __init__.py       # Package version
│       ├── server.py         # MCP server entry point
│       └── tools/
│           ├── __init__.py
│           └── placeholder.py # Tool implementations
├── tests/
│   └── test_placeholder.py   # Unit tests
├── pyproject.toml            # Project configuration
├── README.md
└── claude_desktop_config.json.example
```

### Adding New Tools

1. Add tool definition in `server.py` `list_tools()` function
2. Add tool handler in `server.py` `call_tool()` function
3. Implement tool logic in `tools/` module
4. Add tests in `tests/`

## Integration with pg_workload

This MCP server is designed to work with reports generated by `pg_workload`:

```bash
# Generate a burst mode report
pg_workload run --duration 5m --output report.json

# Generate a simulation report
pg_workload simulate --duration 5m --time-scale 12 \
  --report sim_report.json --timeline timeline.csv
```

Then ask Claude to analyze the reports using the MCP tools.

## License

MIT
